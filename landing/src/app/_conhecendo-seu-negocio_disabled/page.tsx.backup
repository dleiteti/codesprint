'use client';

import { useState, useCallback, memo } from 'react';
import { Send, Sparkles, CheckCircle2, Building2, Target, Users, Palette, Camera, Gift, Phone, Star, ChevronDown, Loader2 } from 'lucide-react';
import Image from 'next/image';
import Link from 'next/link';
import { supabase } from '@/lib/supabase';

const WHATSAPP_LINK = "https://wa.me/5511960552522";

// Move components outside to prevent re-creation
const TextInput = memo(({ name, label, placeholder, required = false, value, onChange }: {
    name: string;
    label: string;
    placeholder: string;
    required?: boolean;
    value: string;
    onChange: (value: string) => void;
}) => (
    <div className="mb-4">
        <label className="block text-sm font-medium text-white mb-2">{label} {required && <span className="text-red-400">*</span>}</label>
        <input
            type="text"
            value={value}
            onChange={(e) => onChange(e.target.value)}
            placeholder={placeholder}
            className="w-full px-4 py-3 bg-slate-800/50 border border-cyan-500/30 rounded-xl text-white placeholder-slate-400 focus:border-cyan-400 transition-all"
        />
    </div>
));

const OptionCard = memo(({ name, options, label, selected, onSelect, customValue, onCustomChange }: {
    name: string;
    options: string[];
    label: string;
    selected: string;
    onSelect: (value: string) => void;
    customValue: string;
    onCustomChange: (value: string) => void;
}) => (
    <div className="mb-6">
        <label className="block text-sm font-medium text-white mb-3">{label}</label>
        <div className="grid grid-cols-2 gap-2">
            {options.map(opt => (
                <button
                    key={opt}
                    type="button"
                    onClick={() => onSelect(opt)}
                    className={`p-3 text-left text-sm rounded-xl border transition-all ${selected === opt ? 'bg-cyan-500/20 border-cyan-400 text-white' : 'bg-slate-800/30 border-cyan-500/20 text-slate-300 hover:border-cyan-500/50'}`}
                >
                    {selected === opt && <CheckCircle2 className="w-4 h-4 inline mr-2 text-cyan-400" />}
                    {opt === 'outro' ? '‚úèÔ∏è Outro...' : opt}
                </button>
            ))}
        </div>
        {selected === 'outro' && (
            <input
                type="text"
                placeholder="Digite aqui..."
                value={customValue}
                onChange={(e) => onCustomChange(e.target.value)}
                className="mt-2 w-full px-4 py-3 bg-slate-800/50 border border-cyan-500/30 rounded-xl text-white placeholder-slate-400 focus:border-cyan-400 transition-all"
            />
        )}
    </div>
));

export default function ConhecendoSeuNegocio() {
    const [currentStep, setCurrentStep] = useState(0);
    const [formData, setFormData] = useState<Record<string, string>>({});
    const [customInputs, setCustomInputs] = useState<Record<string, string>>({});
    const [isSubmitting, setIsSubmitting] = useState(false);

    const steps = [
        { icon: Building2, title: 'Seu Neg√≥cio', desc: 'Informa√ß√µes b√°sicas' },
        { icon: Target, title: 'Objetivo', desc: 'O que voc√™ quer' },
        { icon: Users, title: 'Seu Cliente', desc: 'Quem voc√™ atende' },
        { icon: Palette, title: 'Visual', desc: 'Estilo da p√°gina' },
        { icon: Camera, title: 'Materiais', desc: 'O que voc√™ tem' },
        { icon: Gift, title: 'Oferta', desc: 'Pre√ßos e promo√ß√µes' },
        { icon: Phone, title: 'Contato', desc: 'Como te encontrar' },
        { icon: Star, title: 'Finalizar', desc: 'Enviar briefing' }
    ];

    const handleSelect = useCallback((name: string, value: string) => {
        setFormData(prev => ({ ...prev, [name]: value }));
        if (value !== 'outro') {
            setCustomInputs(prev => ({ ...prev, [name]: '' }));
        }
    }, []);

    const handleCustom = useCallback((name: string, value: string) => {
        setCustomInputs(prev => ({ ...prev, [name]: value }));
    }, []);

    const handleInput = useCallback((name: string, value: string) => {
        setFormData(prev => ({ ...prev, [name]: value }));
    }, []);

    const getValue = (name: string) => {
        const value = formData[name];
        if (Array.isArray(value)) {
            return value.includes('outro') ? [...value.filter(v => v !== 'outro'), customInputs[name]].filter(Boolean).join(', ') : value.join(', ');
        }
        return value === 'outro' ? customInputs[name] : value;
    };

    const handleSubmit = async () => {
        setIsSubmitting(true);

        const briefingData = {
            nome: getValue('nome'),
            empresa: getValue('empresa'),
            whatsapp: getValue('whatsapp'),
            nicho: getValue('nicho'),
            tempo_mercado: getValue('tempo'),
            local_atuacao: getValue('local'),
            objetivo: getValue('objetivo'),
            acao_desejada: getValue('acao'),
            servico_principal: getValue('servico'),
            publico: getValue('publico'),
            renda: getValue('renda'),
            dor_principal: getValue('dor'),
            diferencial: getValue('diferencial'),
            clima: getValue('clima'),
            cores: getValue('cores'),
            tem_logo: getValue('logo'),
            estilo: getValue('estilo'),
            tem_fotos: getValue('fotos'),
            tem_depoimentos: getValue('depoimentos'),
            numeros: getValue('numeros'),
            instagram: getValue('instagram'),
            mostrar_precos: getValue('preco'),
            faixa_preco: getValue('faixa'),
            promocao: getValue('promocao'),
            garantia: getValue('garantia'),
            formas_pagamento: getValue('pagamento'),
            whatsapp_contato: getValue('whatsappFinal'),
            horario: getValue('horario'),
            tempo_resposta: getValue('resposta'),
            urgencia: getValue('urgencia'),
            investimento: getValue('investimento'),
            observacoes: getValue('observacao'),
            status: 'novo'
        };

        try {
            await supabase.from('briefings').insert([briefingData]);
        } catch (error) {
            console.error('Erro ao salvar briefing:', error);
        }

        const data = Object.entries(formData).map(([k, v]) => `*${k}:* ${v === 'outro' ? customInputs[k] : v}`).join('\n');
        const msg = encodeURIComponent(`üöÄ *NOVO BRIEFING - LANDING PAGE*\n\n${data}\n\n_Enviado pelo formul√°rio CodeSprint_`);
        window.open(`${WHATSAPP_LINK}?text=${msg}`, '_blank');

        setIsSubmitting(false);
    };

    const renderStep = () => {
        switch (currentStep) {
            case 0: return (<>
                <TextInput name="nome" label="Seu nome" placeholder="Ex: Ana Silva" required value={formData.nome || ''} onChange={(v) => handleInput('nome', v)} />
                <TextInput name="empresa" label="Nome da empresa/marca" placeholder="Ex: Studio Ana Beauty" required value={formData.empresa || ''} onChange={(v) => handleInput('empresa', v)} />
                <TextInput name="whatsapp" label="WhatsApp" placeholder="(11) 99999-9999" required value={formData.whatsapp || ''} onChange={(v) => handleInput('whatsapp', v)} />
                <OptionCard name="nicho" label="Qual seu nicho?" options={['Est√©tica/Beleza', 'Moda/Roupas', 'Sa√∫de/Fitness', 'Alimenta√ß√£o', 'Advocacia', 'Consultoria', 'Educa√ß√£o/Cursos', 'Im√≥veis', 'Servi√ßos Gerais', 'outro']} selected={formData.nicho || ''} onSelect={(v) => handleSelect('nicho', v)} customValue={customInputs.nicho || ''} onCustomChange={(v) => handleCustom('nicho', v)} />
                <OptionCard name="tempo" label="H√° quanto tempo est√° no mercado?" options={['Come√ßando agora', 'Menos de 1 ano', '1-3 anos', '3-5 anos', 'Mais de 5 anos']} selected={formData.tempo || ''} onSelect={(v) => handleSelect('tempo', v)} customValue={customInputs.tempo || ''} onCustomChange={(v) => handleCustom('tempo', v)} />
                <OptionCard name="local" label="Onde voc√™ atende?" options={['Apenas minha cidade', 'Meu estado', 'Brasil todo', 'Online/Remoto', 'outro']} selected={formData.local || ''} onSelect={(v) => handleSelect('local', v)} customValue={customInputs.local || ''} onCustomChange={(v) => handleCustom('local', v)} />
            </>);
            case 1: return (<>
                <MultiSelectCard name="objetivo" label="Qual o objetivo da p√°gina?" options={['Receber contatos no WhatsApp', 'Vender produto/servi√ßo', 'Capturar e-mails', 'Mostrar portf√≥lio', 'Divulgar evento', 'outro']} selected={Array.isArray(formData.objetivo) ? formData.objetivo : []} onToggle={(v) => handleMultiToggle('objetivo', v)} customValue={customInputs.objetivo || ''} onCustomChange={(v) => handleCustom('objetivo', v)} />
                <MultiSelectCard name="acao" label="O que o visitante deve fazer?" options={['Clicar no WhatsApp', 'Preencher formul√°rio', 'Ver cat√°logo/pre√ßos', 'Agendar hor√°rio', 'Comprar direto', 'outro']} selected={Array.isArray(formData.acao) ? formData.acao : []} onToggle={(v) => handleMultiToggle('acao', v)} customValue={customInputs.acao || ''} onCustomChange={(v) => handleCustom('acao', v)} />
                <MultiSelectCard name="servico" label="Seu servi√ßo principal" options={['Procedimentos est√©ticos', 'Consultoria/Assessoria', 'Produtos f√≠sicos', 'Cursos/Mentorias', 'Servi√ßos de manuten√ß√£o', 'Eventos/Festas', 'outro']} selected={Array.isArray(formData.servico) ? formData.servico : []} onToggle={(v) => handleMultiToggle('servico', v)} customValue={customInputs.servico || ''} onCustomChange={(v) => handleCustom('servico', v)} />
            </>);
            case 2: return (<>
                <OptionCard name="publico" label="Quem √© seu cliente ideal?" options={['Mulheres 18-35', 'Mulheres 35-55', 'Homens 18-35', 'Homens 35-55', 'Empresas/B2B', 'P√∫blico geral', 'outro']} selected={formData.publico || ''} onSelect={(v) => handleSelect('publico', v)} customValue={customInputs.publico || ''} onCustomChange={(v) => handleCustom('publico', v)} />
                <OptionCard name="renda" label="Poder aquisitivo do cliente" options={['Classe C (popular)', 'Classe B (m√©dio)', 'Classe A (premium)', 'Misto']} selected={formData.renda || ''} onSelect={(v) => handleSelect('renda', v)} customValue={customInputs.renda || ''} onCustomChange={(v) => handleCustom('renda', v)} />
                <OptionCard name="dor" label="Qual a maior dor do seu cliente?" options={['Falta de tempo', 'Falta de dinheiro', 'N√£o sabe como resolver', 'J√° tentou e n√£o deu certo', 'Quer resultado r√°pido', 'Quer qualidade/premium', 'outro']} selected={formData.dor || ''} onSelect={(v) => handleSelect('dor', v)} customValue={customInputs.dor || ''} onCustomChange={(v) => handleCustom('dor', v)} />
                <OptionCard name="diferencial" label="Seu diferencial principal" options={['Pre√ßo acess√≠vel', 'Qualidade premium', 'Atendimento r√°pido', 'Experi√™ncia no mercado', 'Resultados comprovados', 'Atendimento personalizado', 'outro']} selected={formData.diferencial || ''} onSelect={(v) => handleSelect('diferencial', v)} customValue={customInputs.diferencial || ''} onCustomChange={(v) => handleCustom('diferencial', v)} />
            </>);
            case 3: return (<>
                <OptionCard name="clima" label="Qual clima quer passar?" options={['Profissional/S√©rio', 'Jovem/Descolado', 'Luxuoso/Premium', 'Acess√≠vel/Popular', 'Moderno/Tech', 'Acolhedor/Familiar', 'Minimalista', 'outro']} selected={formData.clima || ''} onSelect={(v) => handleSelect('clima', v)} customValue={customInputs.clima || ''} onCustomChange={(v) => handleCustom('clima', v)} />
                <OptionCard name="cores" label="Cores preferidas" options={['Rosa/Feminino', 'Azul/Confian√ßa', 'Verde/Natural', 'Preto/Elegante', 'Dourado/Luxo', 'Colorido/Vibrante', 'Deixo voc√™s escolherem', 'outro']} selected={formData.cores || ''} onSelect={(v) => handleSelect('cores', v)} customValue={customInputs.cores || ''} onCustomChange={(v) => handleCustom('cores', v)} />
                <OptionCard name="logo" label="Voc√™ tem logo?" options={['Sim, profissional', 'Sim, mas simples', 'N√£o tenho', 'Preciso criar']} selected={formData.logo || ''} onSelect={(v) => handleSelect('logo', v)} customValue={customInputs.logo || ''} onCustomChange={(v) => handleCustom('logo', v)} />
                <OptionCard name="estilo" label="Estilo de design" options={['Moderno/Tecnol√≥gico', 'Elegante/Sofisticado', 'Divertido/Colorido', 'Cl√°ssico/Tradicional', 'Minimalista/Clean', 'outro']} selected={formData.estilo || ''} onSelect={(v) => handleSelect('estilo', v)} customValue={customInputs.estilo || ''} onCustomChange={(v) => handleCustom('estilo', v)} />
            </>);
            case 4: return (<>
                <OptionCard name="fotos" label="Voc√™ tem fotos profissionais?" options={['Sim, do produto/servi√ßo', 'Sim, minhas/da equipe', 'Tenho do celular', 'N√£o tenho (usem banco)', 'Vou providenciar']} selected={formData.fotos || ''} onSelect={(v) => handleSelect('fotos', v)} customValue={customInputs.fotos || ''} onCustomChange={(v) => handleCustom('fotos', v)} />
                <OptionCard name="depoimentos" label="Tem depoimentos de clientes?" options={['Sim, prints de WhatsApp', 'Sim, avalia√ß√µes Google', 'Tenho v√≠deos', 'N√£o tenho ainda']} selected={formData.depoimentos || ''} onSelect={(v) => handleSelect('depoimentos', v)} customValue={customInputs.depoimentos || ''} onCustomChange={(v) => handleCustom('depoimentos', v)} />
                <OptionCard name="numeros" label="N√∫meros para mostrar" options={['+50 clientes', '+100 clientes', '+500 clientes', 'X anos no mercado', 'N√£o tenho n√∫meros', 'outro']} selected={formData.numeros || ''} onSelect={(v) => handleSelect('numeros', v)} customValue={customInputs.numeros || ''} onCustomChange={(v) => handleCustom('numeros', v)} />
                <OptionCard name="instagram" label="Tem Instagram ativo?" options={['Sim, com bastante conte√∫do', 'Sim, mas pouco', 'Tenho mas n√£o uso', 'N√£o tenho']} selected={formData.instagram || ''} onSelect={(v) => handleSelect('instagram', v)} customValue={customInputs.instagram || ''} onCustomChange={(v) => handleCustom('instagram', v)} />
            </>);
            case 5: return (<>
                <OptionCard name="preco" label="Quer mostrar pre√ßos?" options={['Sim, valor fixo', 'Sim, "a partir de"', 'N√£o, s√≥ pelo WhatsApp', 'Tabela de pre√ßos completa']} selected={formData.preco || ''} onSelect={(v) => handleSelect('preco', v)} customValue={customInputs.preco || ''} onCustomChange={(v) => handleCustom('preco', v)} />
                <OptionCard name="faixa" label="Faixa de pre√ßo do servi√ßo" options={['At√© R$ 100', 'R$ 100 - R$ 500', 'R$ 500 - R$ 1.000', 'R$ 1.000 - R$ 5.000', 'Acima de R$ 5.000', 'Vari√°vel/sob consulta']} selected={formData.faixa || ''} onSelect={(v) => handleSelect('faixa', v)} customValue={customInputs.faixa || ''} onCustomChange={(v) => handleCustom('faixa', v)} />
                <OptionCard name="promocao" label="Tem promo√ß√£o especial?" options={['Sim, desconto √† vista', 'Sim, primeira compra', 'Sim, combo/pacote', 'N√£o tenho', 'outro']} selected={formData.promocao || ''} onSelect={(v) => handleSelect('promocao', v)} customValue={customInputs.promocao || ''} onCustomChange={(v) => handleCustom('promocao', v)} />
                <OptionCard name="garantia" label="Oferece garantia?" options={['Sim, devolu√ß√£o', 'Sim, satisfa√ß√£o', 'Garantia do produto', 'N√£o ofere√ßo', 'outro']} selected={formData.garantia || ''} onSelect={(v) => handleSelect('garantia', v)} customValue={customInputs.garantia || ''} onCustomChange={(v) => handleCustom('garantia', v)} />
                <OptionCard name="pagamento" label="Formas de pagamento" options={['Pix', 'Cart√£o', 'Pix + Cart√£o', 'Todas (pix, cart√£o, boleto)', 'outro']} selected={formData.pagamento || ''} onSelect={(v) => handleSelect('pagamento', v)} customValue={customInputs.pagamento || ''} onCustomChange={(v) => handleCustom('pagamento', v)} />
            </>);
            case 6: return (<>
                <TextInput name="whatsappFinal" label="WhatsApp para receber contatos" placeholder="(11) 99999-9999" required value={formData.whatsappFinal || ''} onChange={(v) => handleInput('whatsappFinal', v)} />
                <TextInput name="instagramLink" label="@ do Instagram" placeholder="@suaempresa" value={formData.instagramLink || ''} onChange={(v) => handleInput('instagramLink', v)} />
                <OptionCard name="horario" label="Hor√°rio de atendimento" options={['Comercial (9h-18h)', 'Manh√£ e tarde', 'Noite tamb√©m', '24 horas', 'S√≥ agendamento']} selected={formData.horario || ''} onSelect={(v) => handleSelect('horario', v)} customValue={customInputs.horario || ''} onCustomChange={(v) => handleCustom('horario', v)} />
                <OptionCard name="resposta" label="Tempo de resposta" options={['At√© 30 minutos', 'At√© 1 hora', 'At√© 24 horas', 'Vari√°vel']} selected={formData.resposta || ''} onSelect={(v) => handleSelect('resposta', v)} customValue={customInputs.resposta || ''} onCustomChange={(v) => handleCustom('resposta', v)} />
            </>);
            case 7: return (<>
                <OptionCard name="urgencia" label="Qual a urg√™ncia?" options={['Preciso para ontem! üî•', 'Essa semana', 'Pr√≥ximos 15 dias', 'Sem pressa']} selected={formData.urgencia || ''} onSelect={(v) => handleSelect('urgencia', v)} customValue={customInputs.urgencia || ''} onCustomChange={(v) => handleCustom('urgencia', v)} />
                <OptionCard name="investimento" label="Investimento previsto" options={['At√© R$ 500', 'R$ 500 - R$ 1.000', 'R$ 1.000 - R$ 2.000', 'Acima de R$ 2.000', 'Quero saber o pre√ßo']} selected={formData.investimento || ''} onSelect={(v) => handleSelect('investimento', v)} customValue={customInputs.investimento || ''} onCustomChange={(v) => handleCustom('investimento', v)} />
                <TextInput name="observacao" label="Algo mais que queira contar? (opcional)" placeholder="Detalhes extras, d√∫vidas..." value={formData.observacao || ''} onChange={(v) => handleInput('observacao', v)} />
                <div className="mt-6 p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
                    <p className="text-green-400 text-sm text-center">‚úÖ Perfeito! Voc√™ receber√° <strong>3 op√ß√µes de layout</strong> em at√© 3 dias √∫teis!</p>
                </div>
            </>);
            default: return null;
        }
    };

    const progress = ((currentStep + 1) / steps.length) * 100;

    return (
        <main className="relative min-h-screen bg-[#0B1120]">
            <div className="absolute inset-0 bg-grid-pattern opacity-30" />
            <div className="absolute inset-0 bg-radial-glow pointer-events-none" />

            <header className="relative z-10 px-4 py-4">
                <nav className="max-w-3xl mx-auto flex items-center justify-between">
                    <Link href="/"><Image src="/logo.png" alt="CodeSprint" width={150} height={38} className="h-8 w-auto" priority /></Link>
                    <span className="text-xs text-cyan-400 bg-cyan-500/10 px-3 py-1 rounded-full hidden sm:block">Briefing</span>
                </nav>
            </header>

            <section className="relative z-10 px-4 py-6">
                <div className="max-w-xl mx-auto">
                    <div className="text-center mb-6">
                        <h1 className="text-xl md:text-2xl font-bold text-white mb-1">{steps[currentStep].title}</h1>
                        <p className="text-slate-400 text-sm">{steps[currentStep].desc}</p>
                    </div>

                    <div className="w-full bg-slate-700/50 rounded-full h-2 mb-6">
                        <div className="bg-gradient-to-r from-cyan-500 to-green-400 h-2 rounded-full transition-all duration-500" style={{ width: `${progress}%` }} />
                    </div>

                    <div className="bg-slate-900/60 backdrop-blur-xl border border-cyan-500/20 rounded-2xl p-5 md:p-6">
                        {renderStep()}

                        <div className="flex gap-3 mt-6">
                            {currentStep > 0 && (
                                <button onClick={() => setCurrentStep(currentStep - 1)} className="flex-1 py-3 bg-slate-700 text-white font-medium rounded-xl hover:bg-slate-600 transition-all text-sm">
                                    ‚Üê Voltar
                                </button>
                            )}
                            {currentStep < steps.length - 1 ? (
                                <button onClick={() => setCurrentStep(currentStep + 1)} className="flex-1 py-3 bg-[#128C7E] text-white font-bold rounded-xl hover:bg-[#075E54] transition-all text-sm flex items-center justify-center gap-2">
                                    Pr√≥ximo ‚Üí
                                </button>
                            ) : (
                                <button onClick={handleSubmit} disabled={isSubmitting} className="flex-1 py-4 bg-[#25D366] text-white font-bold rounded-xl hover:bg-green-500 transition-all flex items-center justify-center gap-2 text-base disabled:opacity-50 disabled:cursor-not-allowed" style={{ boxShadow: '0 0 30px rgba(37, 211, 102, 0.4)' }}>
                                    {isSubmitting ? <><Loader2 className="w-5 h-5 animate-spin" /> Enviando...</> : <><Send className="w-5 h-5" /> Enviar pelo WhatsApp</>}
                                </button>
                            )}
                        </div>
                    </div>

                    <p className="text-center text-slate-500 text-xs mt-4">üîí Informa√ß√µes confidenciais ‚Ä¢ CodeSprint</p>
                </div>
            </section>
        </main>
    );
}
